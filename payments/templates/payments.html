<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
  <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
  <meta name="author" content="pixelstrap">
  <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
  <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
  <title>Zono - Premium Admin Template</title>
  <!-- Google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
  <!-- ico-font-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
  <!-- Themify icon-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
  <!-- Flag icon-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
  <!-- Feather icon-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
  <!-- Plugins css start-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/jsgrid.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
  <!-- Plugins css Ends-->
  <!-- Bootstrap css-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
  <!-- App css-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
  <!-- Responsive css-->
  <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">  
</head>
<style>
  /* å¤–éƒ¨å®¹å™¨æ ·å¼ï¼Œç»Ÿä¸€è®¾ç½®æœ€å¤§å®½åº¦å’Œå±…ä¸­æ˜¾ç¤º */
    .profile-container {
      max-width: 600px; /* è®¾ç½®æœ€å¤§å®½åº¦ */
      margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
      padding: 17px; /* å·¦å³å†…è¾¹è· */
      box-sizing: border-box; /* åŒ…æ‹¬å†…è¾¹è·åœ¨å†…çš„å®½åº¦è®¡ç®— */
    }

    /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ */
    .profile-container .form-control {
      width: 100%; /* è¾“å…¥æ¡†å®½åº¦100%ï¼Œä½†å—å®¹å™¨é™åˆ¶ */
      padding: 10px 12px; /* è¾“å…¥æ¡†å†…è¾¹è· */
      box-sizing: border-box; /* ä¿è¯å®½åº¦åŒ…å«å†…è¾¹è· */
    }

    /* ç»Ÿä¸€æ ‡ç­¾æ ·å¼ */
    .profile-container .form-label {
      display: block; /* æ ‡ç­¾å•ç‹¬ä¸€è¡Œæ˜¾ç¤º */
      margin-bottom: 8px; /* æ ‡ç­¾ä¸è¾“å…¥æ¡†çš„é—´è· */
      color: #333; /* æ ‡ç­¾å­—ä½“é¢œè‰² */
      font-weight: bold; /* æ ‡ç­¾å­—ä½“åŠ ç²— */
    }

    /* æŒ‰é’®æ ·å¼ */
    .profile-container .btn {
      margin-top: 5px; /* æŒ‰é’®ä¸è¾“å…¥æ¡†çš„é—´è· */
      padding: 10px;
      width: 100%;
    }
    /* è®¾ç½®å¤–éƒ¨å®¹å™¨æ•´ä½“æ ·å¼ */
    .card {
      padding: 20px; /* æ·»åŠ å†…è¾¹è· */
      max-width: 800px; /* è®¾ç½®æœ€å¤§å®½åº¦ï¼Œç¡®ä¿ä¸ä¼šè¿‡äºå®½ */
      margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
      box-sizing: border-box; /* åŒ…æ‹¬å†…è¾¹è·åœ¨å†…è®¡ç®—å®½åº¦ */
    }

    /* è¾“å…¥æ¡†å’Œå¤é€‰æ¡†çš„é€šç”¨æ ·å¼ */
    .card .form-control,
    .card input[type="radio"],
    .card input[type="checkbox"] {
      margin-left: 10px; /* å¢åŠ å·¦è¾¹è· */
      margin-bottom: 20px;
    }

    /* æ ‡ç­¾ä¸è¾“å…¥æ¡†å¯¹é½ */
    .card label {
      margin-left: 10px; /* æ ‡ç­¾å·¦è¾¹è· */
      font-weight: bold; /* æ ‡ç­¾åŠ ç²— */
      color: #333; /* æ ‡ç­¾å­—ä½“é¢œè‰² */
    }

    /* è°ƒæ•´å•é€‰æ¡†å’Œå¤é€‰æ¡† */
    .card input[type="radio"],
    .card input[type="checkbox"] {
      margin-right: 5px; /* æ§ä»¶ä¸æ ‡ç­¾ä¹‹é—´çš„é—´è· */
    }

    /* æäº¤æŒ‰é’®æ ·å¼ */
    .card-footer .btn {
      margin-top: 10px;
      padding: 10px 20px;
    }
    .apply-btn {
      display: block;
      margin-left: auto;
      margin-right: 0;
    }
    .radio-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px; /* å¢åŠ æ¯ä¸ªé€‰é¡¹çš„é—´è· */
    }
    
    .radio-option label {
      flex: 1; /* æ ‡ç­¾å æ®å·¦ä¾§ç©ºé—´ */
    }
    
    .radio-option input[type="radio"] {
      margin: 0;
      vertical-align: middle; /* ç¡®ä¿æŒ‰é’®å‚ç›´å±…ä¸­ */
    }
    p {
      font-size: 14px;
      letter-spacing: 0.7px;
      margin-left: 10px;
      line-height: 1.7;
    }
    .delete-card-btn {
      background-color: transparent;  /* åˆå§‹èƒŒæ™¯é€æ˜ */
      border: none;  /* åˆå§‹æ— è¾¹æ¡† */
      color: #6c757d;  /* ç°è‰²æ–‡å­—å’Œå›¾æ ‡ */
      transition: background-color 0.3s ease, border 0.3s ease;  /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
    }
    
    /* è§¦ç¢°æ—¶æ˜¾ç¤ºè¾¹æ¡†å’ŒèƒŒæ™¯é¢œè‰² */
    .delete-card-btn:hover {
      background-color: #f8f9fa;  /* è§¦ç¢°æ—¶èƒŒæ™¯é¢œè‰²å˜ä¸ºæµ…ç°è‰² */
      border: 1px solid #6c757d;  /* è§¦ç¢°æ—¶æ·»åŠ ç°è‰²è¾¹æ¡† */
    }
    
    .delete-address-btn{
      background-color: transparent;  /* åˆå§‹èƒŒæ™¯é€æ˜ */
      border: none;  /* åˆå§‹æ— è¾¹æ¡† */
      color: #6c757d;  /* ç°è‰²æ–‡å­—å’Œå›¾æ ‡ */
      transition: background-color 0.3s ease, border 0.3s ease;  /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
    }
    /* è§¦ç¢°æ—¶æ˜¾ç¤ºè¾¹æ¡†å’ŒèƒŒæ™¯é¢œè‰² */
    .delete-address-btn:hover {
      background-color: #f8f9fa;  /* è§¦ç¢°æ—¶èƒŒæ™¯é¢œè‰²å˜ä¸ºæµ…ç°è‰² */
      border: 1px solid #6c757d;  /* è§¦ç¢°æ—¶æ·»åŠ ç°è‰²è¾¹æ¡† */
    }
  </style>
<body>

<!-- loader starts-->
<div class="loader-wrapper">
  <div class="theme-loader">    
    <div class="loader-p"></div>
  </div>
</div>
<!-- loader ends-->
<!-- tap on top starts-->
<div class="tap-top"><i data-feather="chevrons-up"></i></div>
<!-- tap on tap ends-->
<!-- page-wrapper Start-->
<div class="page-wrapper compact-wrapper" id="pageWrapper">
  <!-- Page Header Start-->
  {% include 'header.html' %}
  <!-- Page Header Ends                              -->
  <!-- Page Body Start-->
  <div class="page-body-wrapper">
    <!-- Page Sidebar Start-->
    {% include 'sidenav.html' %}
    <!-- Page Sidebar Ends -->
    <div class="page-body">
      <div class="container-fluid">
        <div class="page-title">
          <div class="row">
            <div class="col-xl-3 col-sm-5 box-col-4">
              <!-- é¡µé¢æ ‡é¢˜ç•™ç©ºï¼ŒæŒ‰éœ€æ·»åŠ  -->
            </div>
          </div>
        </div>
      </div>

      <!-- Container-fluid starts -->
      <div class="container">
        <div class="row">
            <!-- å·¦ä¾§å†…å®¹ -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <!-- Remaining Balance -->
                  <div class="form-group">
                    <label for="remaining_balance">Remaining Balance</label>
                    <div class="d-flex align-items-center justify-content-between">
                      <input class="form-control w-auto" id="remaining_balance" type="text" value="${{ remaining_balance }}" disabled>
                      <a href="{% url 'transactions' %}" class="ml-2 text-primary align-self-center">See transactions</a>
                    </div>
                    <!-- ä½™é¢ä¸è¶³çš„æç¤ºä¿¡æ¯ -->
                    <div id="insufficientFundsMessage" class="text-danger mt-2" style="display:none;">
                      Insufficient funds, please add money.
                    </div>  
                  </div>

                  <!-- åˆ†éš”çº¿ -->
                  <hr class="my-4">

                  <!-- Step 1: Payment Method Selection -->
                  <div id="payment-method-section">
                    <div class="form-group">
                      <label for="amount">Add Funds</label>
                      <input class="form-control" id="amount" type="number" placeholder="Enter amount">
                    </div>

                    <!-- Select Payment Method -->
                    <div class="form-group">
                      <label>Select Payment Method</label>
                      {% if payment_methods.exists %}
                      {% for method in payment_methods %}
                      <div class="radio-option d-flex justify-content-between align-items-center">
                        <div>
                          <input type="radio" name="payment_method" value="{{ method.stripe_payment_method_id }}" id="payment_method_{{ forloop.counter }}">
                          <label for="payment_method_{{ forloop.counter }}">
                            <!-- å ä½ç¬¦ï¼Œåˆå§‹æ—¶æ˜¾ç¤ºâ€œLoading...â€ -->
                            <span id="brand_{{ forloop.counter }}">Loading...</span> â€¢â€¢â€¢â€¢ <span id="last4_{{ forloop.counter }}">...</span>
                            <br>
                            <small class="text-muted">Created at: {{ method.created_at|date:"Y-m-d H:i:s" }}</small>
                          </label>
                        </div>                     
                        <!-- åˆ é™¤æŒ‰é’® -->
                        <button type="button" class="btn  btn-sm delete-card-btn" data-payment-method-id="{{ method.stripe_payment_method_id }}">
                          ğŸ—‘
                        </button>
                      </div>
                      {% endfor %}
                      {% else %}
                      <p class="text-muted">No payment methods available. Please add one.</p>
                      {% endif %}
                      <!-- Add New Billing Address -->
                      <div class="mt-3">
                        <a href="#" id="add-new-payment-method-link" class="text-primary" data-bs-toggle="modal" data-bs-target="#paymentMethodModal">Add a new payment method</a>
                      </div>

                      <!-- Modal -->
                      <div class="modal fade" id="paymentMethodModal" tabindex="-1" aria-labelledby="paymentMethodModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="paymentMethodModalLabel">Add Payment Method</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <!-- New Payment Method Selection Form -->
                              <div class="form-group">
                                <div class="radio-option">
                                  <p>Debit or Credit Card</p>
                                  <input type="radio" name="payment_method" value="credit_card">
                                </div>
                                <div class="radio-option">
                                  <p>PayPal</p>
                                  <input type="radio" name="payment_method" value="paypal">
                                </div>
                                <div class="radio-option">
                                  <p>Wire Transfer</p>
                                  <input type="radio" name="payment_method" value="add_wire_transfer">
                                </div>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <!-- Next æŒ‰é’® -->
                              <button id="apply-btn" class="btn btn-primary">Next</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Billing Address -->
                      <h5 class="mt-4">Billing Address</h5>
                      <div>
                          {% for address in billing_addresses %}
                          <div class="radio-option d-flex justify-content-between align-items-center">
                            <div>
                              <input type="radio" id="billing_{{ forloop.counter }}" name="billing_address" value="{{ address.id }}">
                              <label for="billing_{{ forloop.counter }}">
                                <strong>{{ address.full_name }}</strong><br>
                                {{ address.address }}{% if address.address_line_2 %}, {{ address.address_line_2 }}{% endif %}<br>
                                {{ address.city }}, {{ address.state }}, {{ address.zip_code }}, {{ address.country_region }}
                              </label>
                            </div>
                            <!-- åˆ é™¤å›¾æ ‡ -->
                            <button type="button" class="btn  btn-sm delete-address-btn" data-address-id="{{ address.id }}" style="height: 36px; width: 36px; display: flex; justify-content: center; align-items: center;">
                              ğŸ—‘
                            </button>
                          </div>
                          {% empty %}
                          <p class="text-muted">No billing addresses found. Please add one.</p>
                          {% endfor %}
                          <!-- Add New Billing Address -->
                          <div class="mt-3">
                            <a href="#" id="add-billing-address-link" class="text-primary" data-bs-toggle="modal" data-bs-target="#billingAddressModal">Add a new billing address</a>
                          </div>

                          <!-- Modal -->
                          <div class="modal fade" id="billingAddressModal" tabindex="-1" aria-labelledby="billingAddressModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title" id="billingAddressModalLabel">Add Billing Address</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                  <!-- Step 3: Add Billing Address Form -->
                                  <div class="form-group">
                                    <label for="country_region">Country or Region</label>
                                    <input class="form-control" id="country_region" type="text" value="United States" readonly>
                                  </div>
                                  <div class="form-group">
                                    <label for="full_name">Full Name</label>
                                    <input class="form-control" id="full_name" type="text" placeholder="Full name">
                                  </div>
                                  <div class="form-group">
                                    <label for="business_name">Business Name (if applicable)</label>
                                    <input class="form-control" id="business_name" type="text" placeholder="Business name">
                                  </div>
                                  <div class="form-group">
                                    <label for="address">Address</label>
                                    <input class="form-control" id="address" type="text" placeholder="Address">
                                  </div>
                                  <div class="form-group">
                                    <label for="address_line_2">Address Line 2 (optional)</label>
                                    <input class="form-control" id="address_line_2" type="text" placeholder="Address line 2 (optional)">
                                  </div>
                                  <div class="form-row">
                                    <div class="form-group col-md-6">
                                      <label for="city">City</label>
                                      <input class="form-control" id="city" type="text" placeholder="City">
                                    </div>
                                    <div class="form-group col-md-3">
                                      <label for="state">State</label>
                                      <input class="form-control" id="state" type="text" placeholder="State">
                                    </div>
                                    <div class="form-group col-md-3">
                                      <label for="zip_code">ZIP Code</label>
                                      <input class="form-control" id="zip_code" type="text" placeholder="ZIP code">
                                    </div>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button id="save-billing-address-btn" class="btn btn-primary">Save</button>
                                </div>
                              </div>
                            </div>
                          </div>

                      </div>
                    </div>
                    <!-- Confirm Payment Button --> 
                    <div class="text-end mt-4">
                      <button id="confirm-payment-btn" class="btn btn-primary">Confirm Payment</button>
                    </div>
                    
                  </div>

                  <!-- Modal for Credit Card -->
                  <div class="modal fade" id="credit-card-modal" tabindex="-1" role="dialog" aria-labelledby="creditCardModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="creditCardModalLabel">Enter Your Credit Card Details</h5>
                        </div>
                        <div class="modal-body">
                          <!-- åŸæœ‰çš„ Stripe.js å¡ç‰‡è¾“å…¥è¡¨å• -->
                          <form id="payment-form" method="POST">
                            {% csrf_token %}
                            <div id="add-payment-form">
                              <h4>Debit or Credit Card</h4> 
                              <!-- æ˜¾ç¤º Stripe.js åˆ›å»ºçš„ä¿¡ç”¨å¡è¾“å…¥æ¡† -->
                              <div id="card-element" class="form-control" style="padding: 10px; border: 1px solid #ced4da; border-radius: 5px;">
                                <!-- Stripe.js å°†åœ¨è¿™é‡ŒæŒ‚è½½ä¿¡ç”¨å¡è¡¨å• -->
                              </div>
                              <div id="card-errors" class="text-danger mt-2" role="alert"></div>
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer">
                          <button type="button" id="back-btn" class="btn btn-secondary">Back</button>
                          <button type="button" id="save-payment-method-btn" class="btn btn-primary">Save</button>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>


          <!-- å³ä¾§å†…å®¹ -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="form-group">
                  <label>Subscription Information</label>
                  <p>Current Subscription</p>
                  
                  <!-- åŠ¨æ€æ˜¾ç¤ºè®¢é˜…ä¿¡æ¯ -->
                  <p>Member Since: {{ subscription.member_since }}</p>
                  <p>Payment Interval: {{ subscription.payment_interval }}</p>
                  <p>Next Payment On: {{ subscription.next_payment_on }}</p>
                  <p>Next Payment Amount: ${{ subscription.next_payment_amount }}</p>
                </div>
                
                <form method="POST" action="{% url 'cancel_subscription' %}">
                  {% csrf_token %}
                  <div class="form-group">
                      <button class="btn btn-primary" style="margin-top: 15px; margin-bottom: 15px; margin-left: 10px;" type="submit">
                          Cancel Next Subscription
                      </button>
                  </div>
                </form>             

                <div class="form-group mt-4">
                  <label for="coupon">Use Coupon</label>
                  <div style="display: flex; align-items: center;">
                      <input class="form-control" id="coupon" type="text" placeholder="Enter coupon code" style="flex: 1; margin-right: 10px; height: 38px;">
                      <button id="apply-coupon-btn" class="btn btn-primary" style="height: 38px; margin-bottom: 20px;">Apply</button>
                  </div>
                  <div id="coupon-message" class="mt-3" style="display: none;">
                      <p id="coupon-error" style="color: red; display: none;"></p>
                      <p id="coupon-success" style="color: green; display: none;"></p>
                  </div>
               </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Container-fluid Ends -->

</div>
<!-- Footer -->
{% include 'footer-light.html' %}

  
</body>
</html>
<!-- latest jquery-->
<script src="{% static 'js/jquery.min.js' %}"></script>
<!-- Bootstrap js-->
<script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
<!-- feather icon js-->
<script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
<script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
<!-- scrollbar js-->
<script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
<script src="{% static 'js/scrollbar/custom.js' %}"></script>
<!-- Sidebar jquery-->
<script src="{% static 'js/config.js' %}"></script>
<!-- Plugins JS start-->
<script src="{% static 'js/sidebar-menu.js' %}"></script>
<script src="{% static 'js/sidebar-pin.js' %}"></script>
<script src="{% static 'js/slick/slick.min.js' %}"></script>
<script src="{% static 'js/slick/slick.js' %}"></script>
<script src="{% static 'js/header-slick.js' %}"></script>
<script src="{% static 'js/jsgrid/jsgrid.min.js' %}"></script>
<script src="{% static 'js/jsgrid/griddata.js' %}"></script>
<script src="{% static 'js/jsgrid/jsgrid.js' %}"></script>
<!-- Plugins JS Ends-->
<!-- Theme js-->
<script src="{% static 'js/script.js' %}"></script>
<script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
<!-- Plugin used-->
<script>
  document.getElementById("apply-coupon-btn").addEventListener("click", function() {
      var couponCode = document.getElementById("coupon").value.trim();
      var messageContainer = document.getElementById("coupon-message");
      var errorMessage = document.getElementById("coupon-error");
      var successMessage = document.getElementById("coupon-success");

      // Clear previous messages
      errorMessage.style.display = "none";
      successMessage.style.display = "none";

      if (couponCode === "") {
          errorMessage.textContent = "Please enter a coupon code.";
          errorMessage.style.display = "block";
          return;
      }

      // Sending AJAX request to backend
      fetch("{% url 'apply_coupon' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"  // Adding CSRF token for security
          },
          body: JSON.stringify({ coupon_code: couponCode })
      })
      .then(response => response.json())
      .then(data => {
          messageContainer.style.display = "block";
          if (data.success) {
              successMessage.textContent = `Coupon applied successfully! Your new balance is: $${data.remaining_balance}`;
              successMessage.style.display = "block";

              // Delay 2 seconds before refreshing the page
              setTimeout(function() {
                  window.location.reload(); // Refresh the page after 2 seconds
              }, 2000); // 2000ms = 2 seconds
          } else {
              errorMessage.textContent = data.error || "Invalid or expired coupon.";
              errorMessage.style.display = "block";
          }
      })
      .catch(error => {
          console.error("Error:", error);
          errorMessage.textContent = "An error occurred. Please try again.";
          errorMessage.style.display = "block";
      });
  });
</script>

<script>
    $(document).ready(function () {
      // ç‚¹å‡» "Next" æŒ‰é’®å¼¹å‡ºæ”¯ä»˜æ–¹å¼è¾“å…¥å¼¹çª—
      $('#apply-btn').click(function (e) {
          e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º

          const paymentOptions = Array.from(document.getElementsByName('payment_method'));
          let selectedOption = null;

          // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼
          for (let i = 0; i < paymentOptions.length; i++) {
              if (paymentOptions[i].checked) {
                  selectedOption = paymentOptions[i].value;
                  break;
              }
          }

          // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ”¯ä»˜æ–¹å¼
          if (selectedOption === 'credit_card') {
              // å…³é—­å½“å‰æ¨¡æ€æ¡†
              $('#paymentMethodModal').modal('hide');

              // å¦‚æœé€‰æ‹©äº† Debit or Credit Cardï¼Œå¼¹å‡ºæ¨¡æ€æ¡†
              $('#credit-card-modal').modal('show'); // æ˜¾ç¤ºå¼¹çª—
          } else {
              alert('Please select Debit or Credit Card to proceed.');
          }
      });


        // ç‚¹å‡» "Back" æŒ‰é’®è¿”å›åˆ°ç¬¬ä¸€æ­¥ 
        $('#back-btn').click(function () {
          $('#credit-card-modal').modal('hide'); // éšè—å½“å‰ä¿¡ç”¨å¡è¾“å…¥çª—å£
          $('#paymentMethodModal').modal('show'); // é‡æ–°æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼é€‰æ‹©çª—å£
      });


    
      // è¿”å›ä¸Šä¸€æ­¥
      document.getElementById('back-btn').addEventListener('click', function() {
      // éšè—åœ°å€é¡µé¢
      document.getElementById('new-billing-address-form').style.display = 'none';

      // Step 2 -> Step 1
      document.getElementById('add-payment-form').style.display = 'none';
      document.getElementById('payment-method-section').style.display = 'block';
      });

  
    // ä¿å­˜è´¦å•åœ°å€ï¼ˆç¬¬ä¸‰æ­¥ï¼‰
    $('#save-billing-address-btn').click(function (e) {
      e.preventDefault();

      // è·å–è´¦å•åœ°å€æ•°æ®
      const countryRegion = $('#country_region').val();
      const fullName = $('#full_name').val();
      const businessName = $('#business_name').val();
      const address = $('#address').val();
      const addressLine2 = $('#address_line_2').val();
      const city = $('#city').val();
      const state = $('#state').val();
      const zipCode = $('#zip_code').val();

      // æ ¡éªŒæ•°æ®
      if (!fullName || !address || !city || !state || !zipCode) {
        alert('Please fill all required address details!');
        return;
      }

      // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯ä¿å­˜è´¦å•åœ°å€
      $.ajax({
        url: '/save-billing-address/', // åç«¯ API è·¯å¾„
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          country_region: countryRegion,
          full_name: fullName,
          business_name: businessName,
          address: address,
          address_line_2: addressLine2,
          city: city,
          state: state,
          zip_code: zipCode,
          csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
        }),
        success: function (response) {
          if (response.success) {
            //alert('Billing address saved successfully!');
            location.reload();  // ä¿å­˜æˆåŠŸååˆ·æ–°é¡µé¢
          } else {
            alert('Error saving billing address: ' + response.message);
          }
        },
        error: function (xhr, status, error) {
          alert('Error processing request: ' + error);
        },
      });
    });

    // æ˜¾ç¤º/éšè—è´¦å•åœ°å€è¡¨å•
    $('#add-billing-address-link').click(function (e) {
      e.preventDefault();
      $('#new-billing-address-form').toggle();
    });

  });
</script>
<!-- ç¬¬äºŒæ­¥ä¿å­˜ä¿¡ç”¨å¡æ“ä½œ -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ä»åç«¯è·å– Publishable Key
    const stripe = Stripe("{{ stripe_publishable_key }}");
  
    const elements = stripe.elements();
  
    // åˆ›å»ºä¿¡ç”¨å¡è¾“å…¥æ¡†
    const cardElement = elements.create("card", {
      style: {
        base: {
          fontSize: "16px",
          color: "#32325d",
          "::placeholder": { color: "#aab7c4" },
        },
        invalid: { color: "#fa755a" },
      },
    });
    cardElement.mount("#card-element");
  
    // ä¿å­˜ PaymentMethod
    const form = document.getElementById("add-payment-form");
    const saveButton = document.getElementById("save-payment-method-btn");
  
    saveButton.addEventListener("click", async (event) => {
      event.preventDefault();
  
      // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
      saveButton.disabled = true;
  
      // åˆ›å»º PaymentMethod
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: "card",
        card: cardElement,
      });
  
      if (error) {
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        document.getElementById("card-errors").textContent = error.message;
        saveButton.disabled = false;
      } else {
        // å°† PaymentMethod ID å‘é€åˆ°åç«¯ä¿å­˜
        const response = await fetch("/save-payment-method/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({ payment_method_id: paymentMethod.id }),
        });
  
        const result = await response.json();
        if (result.success) {
          //alert("Payment method saved successfully!");
          location.reload();  // ä¿å­˜æˆåŠŸååˆ·æ–°é¡µé¢
        } else {
          alert("Error saving payment method: " + result.error);
        }
  
        // é‡æ–°å¯ç”¨æŒ‰é’®
        saveButton.disabled = false;
      }
    });
  });
  
</script>
<script>
  $('#confirm-payment-btn').click(async function (event) {
    // é˜»æ­¢æŒ‰é’®é»˜è®¤è¡Œä¸ºï¼ˆé¡µé¢åˆ·æ–°ï¼‰
    event.preventDefault();

    // è·å–å……å€¼é‡‘é¢
    const addFundsAmount = $('#amount').val();

    // è·å–é€‰ä¸­çš„è´¦å•åœ°å€
    const selectedBillingAddress = $('input[name="billing_address"]:checked').val();

    // è·å–é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼ (PaymentMethod ID)
    const selectedPaymentMethodId = $('input[name="payment_method"]:checked').val();

    // æ ¡éªŒæ•°æ®å®Œæ•´æ€§
    if (!addFundsAmount || !selectedBillingAddress || !selectedPaymentMethodId) {
        alert('Please complete all required fields.');
        return;
    }

    // å‘èµ· AJAX è¯·æ±‚ï¼Œå°† PaymentMethod ID å’Œæ”¯ä»˜ä¿¡æ¯å‘é€åˆ°åç«¯
    $.ajax({
        url: '/process-payment/', // åç«¯æ”¯ä»˜æ¥å£
        type: 'POST',
        data: JSON.stringify({
            payment_method_id: selectedPaymentMethodId, // PaymentMethod ID
            billing_address_id: selectedBillingAddress, // è´¦å•åœ°å€ ID
            amount: addFundsAmount, // æ”¯ä»˜é‡‘é¢
        }),
        contentType: 'application/json',
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        success: function (response) {
            if (response.success) {
                //alert('Payment processed successfully!');
                location.reload(); // åˆ·æ–°é¡µé¢æˆ–è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
            } else if (response.requires_action) {
                handleAction(response.client_secret); // å¦‚æœéœ€è¦ 3D Secure éªŒè¯
            } else {
                alert('Payment failed: ' + response.error);
            }
        },
        error: function (error) {
            alert('An error occurred: ' + error.responseText);
        },
    });
  });

  // ä½¿ç”¨ Stripe.js å¤„ç† 3D Secure éªŒè¯
  async function handleAction(clientSecret) {
      const stripe = Stripe('your-publishable-key');
      const { error } = await stripe.confirmCardPayment(clientSecret);
      if (error) {
          alert('3D Secure verification failed: ' + error.message);
      } else {
          alert('Payment succeeded!');
          location.reload(); // åˆ·æ–°é¡µé¢
      }
  }
</script>
<script>
  $(document).ready(function () {
    // åŠ¨æ€è·å–æ¯ä¸ªæ”¯ä»˜æ–¹å¼çš„å“ç‰Œå’Œå¡å·åå››ä½
    $('input[name="payment_method"]').each(function (index) {
      const paymentMethodId = $(this).val(); // è·å–æ”¯ä»˜æ–¹å¼çš„ Stripe ID
      const brandSpan = $(`#brand_${index + 1}`); // è·å–å“ç‰Œæ˜¾ç¤ºçš„å…ƒç´ 
      const last4Span = $(`#last4_${index + 1}`); // è·å–å¡å·åå››ä½æ˜¾ç¤ºçš„å…ƒç´ 
  
      // è°ƒç”¨åç«¯æ¥å£è·å–è¯¦ç»†ä¿¡æ¯
      $.ajax({
        url: '/get-payment-method-details/', // åç«¯æ¥å£ URL
        type: 'POST',
        data: JSON.stringify({ payment_method_id: paymentMethodId }),
        contentType: 'application/json',
        headers: { "X-CSRFToken": "{{ csrf_token }}" }, // Django CSRF ä»¤ç‰Œ
        success: function (response) {
          if (response.success) {
            // æ›´æ–°å“ç‰Œå’Œå¡å·åå››ä½
            brandSpan.text(response.card_info.brand);
            last4Span.text(response.card_info.last4);
          } else {
            // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
            brandSpan.text('Unknown');
            last4Span.text('****');
          }
        },
        error: function (error) {
          // å¤„ç†é”™è¯¯
          brandSpan.text('Error');
          last4Span.text('****');
          console.error('Failed to fetch payment method details:', error);
        },
      });
    });
  });
</script>
<script>
  $(document).ready(function () {
    // åˆ é™¤æ”¯ä»˜æ–¹å¼
    $('.delete-card-btn').click(function () {
      const paymentMethodId = $(this).data('payment-method-id'); // è·å–æ”¯ä»˜æ–¹å¼ ID
  
      if (confirm('Are you sure you want to delete this payment method?')) {
        $.ajax({
          url: '/delete-payment-method/', // åç«¯åˆ é™¤æ”¯ä»˜æ–¹å¼çš„æ¥å£
          type: 'POST',
          data: JSON.stringify({ payment_method_id: paymentMethodId }),
          contentType: 'application/json',
          headers: { "X-CSRFToken": "{{ csrf_token }}" }, // Django çš„ CSRF ä»¤ç‰Œ
          success: function (response) {
            if (response.success) {
              //alert('Payment method deleted successfully!');
              location.reload(); // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ˜¾ç¤º
            } else {
              alert('Failed to delete payment method: ' + response.error);
            }
          },
          error: function (error) {
            alert('An error occurred: ' + error.responseText);
          },
        });
      }
    });
  });
</script>
<script>
  $(document).ready(function () {
    // ç›‘å¬åˆ é™¤åœ°å€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.delete-address-btn').click(function () {
      const addressId = $(this).data('address-id'); // è·å–åœ°å€ ID
  
      // ç¡®è®¤åˆ é™¤æ“ä½œ
      if (confirm('Are you sure you want to delete this address?')) {
        $.ajax({
          url: '/delete-billing-address/', // åç«¯æ¥å£ URL
          type: 'POST',
          data: JSON.stringify({ address_id: addressId }), // ä¼ é€’åœ°å€ ID
          contentType: 'application/json',
          headers: { "X-CSRFToken": "{{ csrf_token }}" }, // Django çš„ CSRF ä»¤ç‰Œ
          success: function (response) {
            if (response.success) {
              //alert('Address deleted successfully!');
              location.reload(); // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ˜¾ç¤º
            } else {
              alert('Failed to delete address: ' + response.error);
            }
          },
          error: function (error) {
            alert('An error occurred: ' + error.responseText);
          },
        });
      }
    });
  });
</script>
<script>
  document.getElementById('add-new-payment-method-link').addEventListener('click', function(e) {
    e.preventDefault();  // é˜»æ­¢é“¾æ¥çš„é»˜è®¤è¡Œä¸º
    
    // è·å–æ”¯ä»˜æ–¹å¼è¡¨å•
    var paymentMethodForm = document.getElementById('payment-method-form');
    
    // æ£€æŸ¥å½“å‰è¡¨å•çš„æ˜¾ç¤ºçŠ¶æ€å¹¶åˆ‡æ¢æ˜¾ç¤º/éšè—
    if (paymentMethodForm.style.display === 'none' || paymentMethodForm.style.display === '') {
      paymentMethodForm.style.display = 'block';  // æ˜¾ç¤ºè¡¨å•
    } else {
      paymentMethodForm.style.display = 'none';  // éšè—è¡¨å•
    }
  });
</script>
<!--å–æ¶ˆè®¢é˜…-->
<script>
  document.getElementById('cancel-subscription-btn').addEventListener('click', function() {
      fetch('{% url 'cancel_subscription' %}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: JSON.stringify({}),
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert('è®¢é˜…å·²å–æ¶ˆï¼Œç”¨æˆ·ç±»å‹å·²è®¾ç½®ä¸º 0');
          } else {
              alert('å–æ¶ˆè®¢é˜…å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
      });
  });
</script>

<script>
  $(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('error') === 'insufficient_funds') {
        $('#insufficientFundsMessage').show(); // å¦‚æœä½™é¢ä¸è¶³ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
    }
});
</script>