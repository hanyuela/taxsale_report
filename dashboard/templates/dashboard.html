<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="pixelstrap">
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Zono - Premium Admin Template</title>
    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
    <!-- ico-font-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
    <!-- Themify icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
    <!-- Flag icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
    <!-- Feather icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/todo.css' %}">
    <!-- Plugins css Ends-->
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
    <!-- App css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
    <!-- Responsive css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
  </head>
  <style>
    .task-label {
        padding-left: 20px;
    }
    /* 调整select框的样式 */
    .select-wrapper select {
        background-color: #f8f9fa; /* 设置背景颜色与现有一致 */
        border: 1px solid #ccc; /* 设置边框颜色与现有一致 */
        padding: 5px 10px; /* 调整内边距使其看起来更一致 */
        border-radius: 4px; /* 添加圆角 */
        font-size: 14px; /* 保持字体大小一致 */
    }

    /* 为新任务添加select选择框的包裹样式 */
    .task-container select {
        background-color: #f8f9fa; /* 确保新任务的选择框背景一致 */
        border: 1px solid #ccc; /* 边框样式一致 */
        padding: 5px 10px; /* 内边距一致 */
        border-radius: 4px; /* 圆角一致 */
    }
    .form-label {
      font-weight: 600;
      margin-bottom: 4px;
      margin-top: 15px;
    }
  </style>
  <body>
    <!-- tap on top starts-->
    <div class="tap-top"><i data-feather="chevrons-up"></i></div>
    <!-- tap on tap ends--> 
    <!-- loader starts-->
    <div class="loader-wrapper">
      <div class="theme-loader">    
        <div class="loader-p"></div>
      </div>
    </div>
    <!-- loader ends-->
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      <!-- Page Header Start-->
      {% include 'header.html' %}
      <!-- Page Header Ends                              -->
      <!-- Page Body Start-->
      <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        {% include 'sidenav.html' %}
        <!-- Page Sidebar Ends-->
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                <div class="col-xl-4 col-sm-7 box-col-3">
                  <h3>To-Do</h3>
                </div>
                <div class="col-5 d-none d-xl-block">
                  <!-- Page Sub Header Start-->
                  
                  <!-- Page Sub Header end
                  -->
                </div>
              </div>
            </div>
          </div>
          <!-- Container-fluid starts-->
          <div class="container-fluid email-wrap bookmark-wrap todo-wrap">
            <div class="row">
              <div class="col-xxl-3 col-xl-4 box-col-4e">
                <div class="email-sidebar md-sidebar">
                  <a class="btn btn-primary email-aside-toggle md-sidebar-toggle">To Do filter</a>
                  <div class="email-left-aside md-sidebar-aside">
                    <div class="card">
                      <div class="card-body">
                        <div class="email-app-sidebar left-bookmark custom-scrollbar">
                          <!-- To-Do Filter部分 -->
                          <ul class="nav main-menu custom-scrollbar">
                            <li class="nav-item">
                              <button class="btn-primary badge-light d-block btn-mail w-100 txt-light" id="all-task-btn">
                                <i class="me-2" data-feather="check-circle"> </i>All Task
                              </button>
                            </li>
                            <li class="nav-item">
                              <a href="javascript:void(0)" id="in-progress-btn">
                                <span class="iconbg badge-light-primary"><i data-feather="file-plus"></i></span>
                                <span class="title ms-2">In Progress</span>
                              </a>
                            </li>
                            <li class="nav-item">
                              <a href="javascript:void(0)" id="pending-btn">
                                <span class="iconbg badge-light-success"><i data-feather="check-circle"></i></span>
                                <span class="title ms-2">Pending</span>
                              </a>
                            </li>
                            <li class="nav-item">
                              <a href="javascript:void(0)" id="done-btn">
                                <span class="iconbg badge-light-danger"><i data-feather="cast"></i></span>
                                <span class="title ms-2">Done</span>
                              </a>
                            </li>
                            <li class="nav-item">
                              <a href="javascript:void(0)" id="archived-btn">
                                <span class="iconbg badge-light-info"><i data-feather="activity"></i></span>
                                <span class="title ms-2">Archived</span>
                              </a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xxl-9 col-xl-8 box-col-8">
                <div class="card">
                  <div class="card-header b-bottom">
                    <div class="todo-list-header">
                      <div class="new-task-wrapper input-group">
                        <!-- Task Content Input -->
                        <label for="taskContent" class="form-label" style="margin-right: 10px;">Task Content</label>
                        <input class="form-control m-0 half-width" id="taskContent" placeholder="Enter task content here...">
                        
                        <!-- Deadline Input -->
                        <label for="taskDeadline" class="form-label" style="margin-right: 10px; margin-left: 20px;">Deadline</label>
                        <input type="date" class="form-control m-0 half-width" id="taskDeadline">
                        
                        <button class="btn btn-primary add-new-task-btn" id="add-task-btn" style="margin-left: 20px;">Add Task</button>
                      </div>                   
                    </div>
                </div>
                  <div class="card-body">
                    <div class="todo">
                      <div class="todo-list-wrapper custom-scrollbar">
                        <div class="todo-list-container">
                          <div class="todo-list-body">
                            <!-- 任务列表 -->
                            <ul id="todo-list">
                              {% for task in tasks %}
                                <li class="task {% if task.label == 'Archived' and not show_archived %}d-none{% endif %}">
                                  <div class="task-container">
                                    <h4 class="task-label">{{ task.content }}</h4>
                                    <div class="d-flex align-items-center gap-3">
                                      <!-- 任务标签部分 -->
                                      <span class="badge badge-light-primary">
                                        <select class="task-status" onchange="updateTaskStatus({{ task.id }}, this.value)">
                                          <option value="In Progress" {% if task.label == 'In Progress' %}selected{% endif %}>In Progress</option>
                                          <option value="Pending" {% if task.label == 'Pending' %}selected{% endif %}>Pending</option>
                                          <option value="Done" {% if task.label == 'Done' %}selected{% endif %}>Done</option>
                                          <option value="Archived" {% if task.label == 'Archived' %}selected{% endif %}>Archived</option>
                                        </select>
                                      </span>
                                      <h5 class="assign-name m-0">{{ task.deadline }}</h5>
                                      <span class="task-action-btn">
                                        <span class="action-box large delete-btn" title="Delete Task" onclick="deleteTask({{ task.id }})">
                                          <i class="icon"><i class="icon-trash"></i></i>
                                        </span>
                                      </span>
                                    </div>
                                  </div>
                                </li>
                              {% endfor %}
                            </ul>                            
                          </div>
                        </div>
                      </div>
                      <div class="notification-popup hide">
                        <p><span class="task"></span><span class="notification-text"></span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Container-fluid Ends-->
          </div>
          <!-- footer start-->
          {% include 'footer-light.html' %}

          <!-- CSRF Token -->
          {% csrf_token %}
          <script>
            document.getElementById('add-task-btn').addEventListener('click', function() {
              const taskContent = document.getElementById('taskContent').value;
              const taskDeadline = document.getElementById('taskDeadline').value;
          
              if (!taskContent || !taskDeadline) {
                  alert('Please enter both task content and deadline!');
                  return;
              }
          
              const formData = new FormData();
              formData.append('content', taskContent);
              formData.append('deadline', taskDeadline);
          
              fetch('/add-task/', {
                  method: 'POST',
                  body: formData,
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      // 创建新任务的HTML
                      
                      const newTaskHTML = `
                        <li class="task">
                            <div class="task-container">
                                <h4 class="task-label">${data.task.content}</h4>
                                <div class="d-flex align-items-center gap-3">
                                    <!-- 任务标签部分 -->
                                    <span class="badge badge-light-primary">
                                        <select class="task-status" onchange="updateTaskStatus(${data.task.id}, this.value)">
                                            <option value="In Progress" ${data.task.label == 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Pending" ${data.task.label == 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Done" ${data.task.label == 'Done' ? 'selected' : ''}>Done</option>
                                            <option value="Archived" ${data.task.label == 'Archived' ? 'selected' : ''}>Archived</option>
                                        </select>
                                    </span>
                                    <h5 class="assign-name m-0">${data.task.deadline}</h5>
                                    <span class="task-action-btn">
                                        <span class="action-box large delete-btn" title="Delete Task" onclick="deleteTask(${data.task.id})">
                                            <i class="icon"><i class="icon-trash"></i></i>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </li>
                    `;

                      // 插入新的任务到任务列表
                      document.getElementById('todo-list').insertAdjacentHTML('beforeend', newTaskHTML);
                      // 清空输入框
                      document.getElementById('taskContent').value = '';
                      document.getElementById('taskDeadline').value = '';
                  } else {
                      alert('There was an error saving the task.');
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('There was an error saving the task.');
              });
          });
          </script>
          <script>
            // 默认显示所有任务，包括 Archived
            let showArchived = false;  // 默认显示所有任务（包括Archived）
            let showInProgress = true;
            let showPending = true;
            let showDone = true;
        
            // 点击 All Task 时，显示所有任务（包括 Archived）
            document.getElementById('all-task-btn').addEventListener('click', function() {
                showArchived = true;
                showInProgress = true;
                showPending = true;
                showDone = true;
                filterTasks();
            });
        
            // 点击 In Progress 时，显示 In Progress 任务
            document.getElementById('in-progress-btn').addEventListener('click', function() {
                showInProgress = true;
                showArchived = false;
                showPending = false;
                showDone = false;
                filterTasks();
            });
        
            // 点击 Pending 时，显示 Pending 任务
            document.getElementById('pending-btn').addEventListener('click', function() {
                showPending = true;
                showArchived = false;
                showInProgress = false;
                showDone = false;
                filterTasks();
            });
        
            // 点击 Done 时，显示 Done 任务
            document.getElementById('done-btn').addEventListener('click', function() {
                showDone = true;
                showArchived = false;
                showInProgress = false;
                showPending = false;
                filterTasks();
            });
        
            // 点击 Archived 时，显示 Archived 任务
            document.getElementById('archived-btn').addEventListener('click', function() {
                showArchived = true;
                showInProgress = false;
                showPending = false;
                showDone = false;
                filterTasks();
            });
        
            // 过滤任务，显示或隐藏根据状态选择的任务
            function filterTasks() {
                const tasks = document.querySelectorAll('#todo-list .task');
                tasks.forEach(function(task) {
                    const taskStatus = task.querySelector('.task-status').value;
                    if (taskStatus === 'Archived') {
                        if (showArchived) {
                            task.classList.remove('d-none');  // 显示 Archived 任务
                        } else {
                            task.classList.add('d-none');  // 隐藏 Archived 任务
                        }
                    } else if (taskStatus === 'In Progress' && showInProgress) {
                        task.classList.remove('d-none'); // 显示 In Progress 任务
                    } else if (taskStatus === 'Pending' && showPending) {
                        task.classList.remove('d-none'); // 显示 Pending 任务
                    } else if (taskStatus === 'Done' && showDone) {
                        task.classList.remove('d-none'); // 显示 Done 任务
                    } else {
                        task.classList.add('d-none');  // 隐藏其他任务
                    }
                });
            }
        
            // 初始化时，根据按钮点击的状态，显示或者隐藏任务
            filterTasks();
          </script>
          <script>
            // 更新任务状态的函数
            function updateTaskStatus(taskId, status) {
              console.log("Selected status:", status);  // 打印选中的标签，检查是否正确传递

              fetch(`/update-task-status/${taskId}/`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                  },
                  body: JSON.stringify({ label: status })  // 传递标签
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      // 在这里可以更新前端任务状态的显示
                      console.log('Task status updated:', data);
                  } else {
                      console.error('Failed to update task label:', data);
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
              });
            }
          </script>
          <script>
            // 删除任务
            function deleteTask(taskId) {
              if (confirm('Are you sure you want to delete this task?')) {
                fetch(`/delete-task/${taskId}/`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                  }
                })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    // 删除任务后，从 DOM 中移除对应任务
                    const taskElement = document.querySelector(`#todo-list .task[data-id="${taskId}"]`);
                    if (taskElement) {
                      taskElement.remove();
                    }
          
                    // 自动刷新当前页面
                    window.location.reload();
                  } else {
                    alert('Error: Unable to delete task.');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('Error: Unable to delete task.');
                });
              }
            }
          </script>          
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
          <!-- latest jquery-->
          <script src="{% static 'js/jquery.min.js' %}"></script>
          <!-- Bootstrap js-->
          <script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
          <!-- feather icon js-->
          <script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
          <script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
          <!-- scrollbar js-->
          <script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
          <script src="{% static 'js/scrollbar/custom.js' %}"></script>
          <!-- Sidebar jquery-->
          <script src="{% static 'js/config.js' %}"></script>
          <!-- Plugins JS start-->
          <script src="{% static 'js/sidebar-menu.js' %}"></script>
          <script src="{% static 'js/sidebar-pin.js' %}"></script>
          <script src="{% static 'js/slick/slick.min.js' %}"></script>
          <script src="{% static 'js/slick/slick.js' %}"></script>
          <script src="{% static 'js/header-slick.js' %}"></script>
          <!-- Plugins JS Ends-->
          <!-- Theme js-->
          <script src="{% static 'js/script.js' %}"></script>
          <script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
          <!-- Plugin used-->
  </body>
</html>