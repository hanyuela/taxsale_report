<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="pixelstrap">
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Zono - Premium Admin Template</title>
    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
    <!-- ico-font-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
    <!-- Themify icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
    <!-- Flag icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
    <!-- Feather icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatables.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatable-extension.css' %}">
    <!-- Plugins css Ends-->
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
    <!-- App css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
    <!-- Responsive css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
    </head>
    <style>
      /* 调整 .card-header 布局，使标题和搜索框分开显示 */
      .card-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .header-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0; /* 避免额外的填充 */
      }
      
      /* 搜索框的样式调整，确保在右侧显示并不遮挡其他内容 */
      #search-container .dataTables_filter {
          position: relative;
          right: 0;
          top: 0;
          z-index: 10;
          margin-bottom: 0;
          margin: 0;
      }

      /* 搜索框输入框的样式 */
      .dataTables_filter input {
          border: 1px solid #ddd;
          padding: 0px;
          border-radius: 4px;
      }

      /* 页面整体布局调整 */
      .page-body-wrapper {
          padding-left: 0;
      }

      .container-fluid {
          padding-top: 30px;
          padding-right: 20px;
          padding-left: 0;
      }

      .page-wrapper, .page-body {
          min-height: 100vh;
      }

      /* DataTable 表格样式 */
      #keytable {
          width: 100%;
          margin: 0 auto;
      }

      #keytable th, #keytable td {
          white-space: nowrap;
          padding: 8px;
      }

      /* 表头和内容之间的间距 */
      #keytable thead th {
          padding-bottom: 15px;
      }

      /* 分页按钮样式 */
      .dataTables_paginate {
          margin-top: 10px;
          display: flex;
          justify-content: flex-end;
      }
      #confirm-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
    <body>
    {% if messages %}
    <div class="notifications">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %} 
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      {% include 'header.html' %}
      <div class="page-body-wrapper horizontal-menu">
        {% include 'sidenav.html' %}
        <div class="page-body">
          <div class="container-fluid">
            <div class="row"> 
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header pb-0 card-no-border">
                    <div class="header-content">
                        <div id="search-container"></div> <!-- 搜索框的容器 -->
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="display" id="keytable">
                        <thead>
                            <tr>
                                <th>street address</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Property Type</th>
                                <th>Is Online</th>
                                <th>Auction Type</th>
                                <th>Amount In Sale</th>
                                <th>Deposit Deadline</th>
                                <th>Foreclose Score</th>
                                <th>Action</th>
                                <th><input type="checkbox" id="select_all" /></th> <!-- 表头全选 -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr>
                                <td>{{ item.street_address}}
                                <td>{{ item.city }}</td>
                                <td>{{ item.state }}</td>
                                <td>{{ item.property_class }}</td>
                                <td>{{ item.is_online }}</td>
                                <td>{{ item.auction_type }}</td>
                                <td>${{ item.amount_in_sale }}</td>
                                <td>{% if item.deposit_deadline %}{{ item.deposit_deadline }}{% else %}N/A{% endif %}</td>
                                <td><span class="badge badge-light-warning">{{ item.foreclose_score }}</span></td>
                                <td>
                                      <ul class="action">
                                          
                                          <li class="delete">
                                            <a href="#" data-property-id="{{ item.property_id }}" data-user-id="{{ user.id }}">
                                                <i class="fa fa-shopping-cart"></i>
                                            </a>
                                          </li>
                                      </ul>
                                </td>
                                <td><input type="checkbox" class="row-select" /></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 弹出框 -->
        <div id="confirm-modal" style="display: none;">
          <div class="modal-content">
              <p>Are you sure you want to view this report?</p>
              <label>
                  <input type="checkbox" id="default-checkbox"> 
                  Agree to pay by default without showing this notification next time
              </label><br>
              <button id="agree-button">agree</button>
              <button id="cancel-button">cancel</button>
          </div>
        </div>
        {% include 'footer-light.html' %}
          </div>
        </div> 
    <!-- 弹出窗口 -->
    <!-- jQuery -->
    <script>
        $(document).ready(function() {
            // 监听全选复选框的点击事件
            $('#select_all').click(function() {
                var isChecked = $(this).prop('checked');  // 获取全选框的状态
                $('.row-select').prop('checked', isChecked);  // 设置所有行的复选框为相同状态
            });
    
            // 监听每一行的点击事件，排除购物车按钮点击
            $('#keytable tbody tr').click(function(e) {
                // 如果点击的是购物车按钮，直接返回，不做处理
                if ($(e.target).closest('.delete a').length > 0) {
                    return;
                }
                var checkbox = $(this).find('.row-select');  // 获取当前行的复选框
                checkbox.prop('checked', !checkbox.prop('checked'));  // 反转选中状态
            });
    
            // 监听每个复选框的点击事件，防止影响到行点击的事件
            $('.row-select').click(function(e) {
                e.stopPropagation();  // 阻止点击事件冒泡到行上
            });
    
            // 购物车按钮的点击事件
            $('.delete a').click(function(e) {
                e.preventDefault();  // 阻止默认行为
                // 单独执行购物车的逻辑
                console.log("购物车按钮被点击！");
            });
        });
    </script>
    
      
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>   
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <!-- Bootstrap js-->
    <script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <!-- feather icon js-->
    <script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
    <script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
    <!-- scrollbar js-->
    <script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
    <script src="{% static 'js/scrollbar/custom.js' %}"></script>
    <!-- Sidebar jquery-->
    <script src="{% static 'js/config.js' %}"></script>
    <!-- Plugins JS start-->
    <script src="{% static 'js/sidebar-menu.js' %}"></script>
    <script src="{% static 'js/sidebar-pin.js' %}"></script>
    <script src="{% static 'js/slick/slick.min.js' %}"></script>
    <script src="{% static 'js/slick/slick.js' %}"></script>
    <script src="{% static 'js/header-slick.js' %}"></script>
    <script src="{% static 'js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/jszip.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/pdfmake.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/vfs_fonts.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.autoFill.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.select.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.html5.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.print.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/responsive.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.keyTable.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.colReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.fixedHeader.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.rowReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.scroller.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/custom.js' %}"></script>
    <script src="{% static 'js/tooltip-init.js' %}"></script>
    <!-- Plugins JS Ends-->
    <!-- Theme js-->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
    <!-- Plugin used-->
    <script>
        $(document).ready(function() {
            
            // 初始化 DataTable
            if (!$.fn.DataTable.isDataTable('#keytable')) {
                $('#keytable').DataTable({
                    "autoWidth": false,
                    "responsive": true,
                    "columnDefs": [
                        { "width": "15%", "targets": 0 },
                        { "width": "15%", "targets": 1 },
                        { "width": "20%", "targets": 2 }
                    ]
                });
            }
    
            // 将搜索框移动到 .card-header 中
            $(".dataTables_filter").detach().appendTo(".card-header");
    
            // 添加“统一购买”按钮到分页控件的最后
            $(".dataTables_paginate").append('<button class="bulk-purchase-btn btn btn-primary" style="margin-left: 10px;"><i class="fa fa-shopping-cart"></i></button>');
            // 添加购物车按钮函数
            function addBulkPurchaseButton() {
                if (!$(".bulk-purchase-btn").length) { // 检查按钮是否已经存在
                    $(".dataTables_paginate").append('<button class="bulk-purchase-btn btn btn-primary" style="margin-left: 10px;"><i class="fa fa-shopping-cart"></i></button>');
                }
            }

            // 初始加载时添加按钮
            addBulkPurchaseButton();

            // 监听 DataTables 的 draw 事件，确保分页或操作时按钮不被删除
            $('#keytable').on('draw.dt', function() {
                addBulkPurchaseButton();
            });
            
            // 绑定“统一购买”按钮的点击事件
            $(document).on('click', '.bulk-purchase-btn', function() {
                var selectedRows = $('.row-select:checked');
    
                // 检查是否有选中的行
                if (selectedRows.length > 0) {
                    var bulkData = [];
                    var checkRequests = []; // 用于存放检查请求
                    
                    selectedRows.each(function() {
                        var row = $(this).closest('tr'); // 获取当前行
                        var propertyId = row.find('.delete a').data('property-id'); // 从 `a` 标签中获取 data-property-id
                        var userId = row.find('.delete a').data('user-id'); // 从 `a` 标签中获取 data-user-id
                    
                        if (propertyId && userId) {
                            bulkData.push({ propertyId, userId });
    
                            // 检查 `agreement_exists`
                            var checkRequest = $.ajax({
                                url: '/check-agreement/',
                                method: 'GET',
                                data: {
                                    property_id: propertyId,
                                    user_id: userId,
                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    if (response.success) {
                                        if (response.agreement_exists) {
                                            // 如果 agreement_exists 为 true，直接处理
                                            $.ajax({
                                                url: '/agree-to-view/',
                                                method: 'POST',
                                                data: {
                                                    property_id: propertyId,
                                                    user_id: userId,
                                                    default: true, // 直接默认同意
                                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                                },
                                                success: function(res) {
                                                    if (res.success) {
                                                        console.log(`成功处理 property_id: ${propertyId}`);
                                                    }
                                                },
                                                error: function(xhr, status, error) {
                                                    console.error(`处理失败 property_id: ${propertyId}, 错误: ${error}`);
                                                }
                                            });
                                        }
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error(`检查失败 property_id: ${propertyId}, 错误: ${error}`);
                                }
                            });
                            checkRequests.push(checkRequest);
                        } else {
                            console.log("缺少 property_id 或 user_id，跳过该行");
                        }
                    });
    
                    // 等待所有检查请求完成
                    $.when.apply($, checkRequests).done(function() {
                        // 检查完毕后，过滤出需要弹出同意窗口的数据
                        var pendingApproval = bulkData.filter(function(item) {
                            // 根据检查结果决定是否需要同意窗口
                            var checkbox = $(`.delete a[data-property-id="${item.propertyId}"]`);
                            return !checkbox.data('agreement-exists'); // 只有 `agreement_exists == false` 才需要弹窗
                        });
    
                        if (pendingApproval.length > 0) {
                            // 弹出同意窗口，保存待处理数据
                            window.bulkSelectedData = pendingApproval;
                            $('#confirm-modal').fadeIn();
                        } else {
                            alert("已成功处理所有选中项！");
                        }
                    });
                } else {
                    alert("请先选择至少一项进行购买！");
                }
            });
    
            // 弹窗中“同意”按钮的逻辑
            // 弹窗中“同意”按钮的逻辑
            $('#agree-button').off('click').on('click', function() {
                if (window.bulkSelectedData && window.bulkSelectedData.length > 0) {
                    var requests = [];
                    var hasPurchased = false; // 标志是否存在已购买的项
                    var hasProcessed = false; // 标志是否有成功处理的项

                    window.bulkSelectedData.forEach(function(item) {
                        var request = $.ajax({
                            url: '/agree-to-view/',
                            method: 'POST',
                            data: {
                                property_id: item.propertyId,
                                user_id: item.userId,
                                default: $('#default-checkbox').is(':checked'),
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(response) {
                                if (response.success) {
                                    if (response.agreement_exists) {
                                        // 如果返回已购买，提示用户
                                        alert(`Property ID: ${item.propertyId} 的数据已被购买！`);
                                        hasPurchased = true; // 设置标志
                                    } else {
                                        // 提示用户未被购买的数据已成功处理
                                        alert(`Property ID: ${item.propertyId} 的数据已成功处理！`);
                                        console.log(`成功处理 property_id: ${item.propertyId}`);
                                        hasProcessed = true; // 有成功处理的数据
                                    }
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error(`请求失败 property_id: ${item.propertyId}, 错误: ${error}`);
                            }
                        });
                        requests.push(request);
                    });

                    // 等待所有请求完成
                    $.when.apply($, requests).done(function() {
                        // 如果有成功处理的数据，清空数据并关闭弹窗
                        if (hasProcessed) {
                            window.bulkSelectedData = []; // 清空数据
                            $('#confirm-modal').fadeOut();
                            console.log("已成功处理所有选中项！");
                        }

                        // 如果所有数据均已被购买，仅提示，不清空数据或关闭弹窗
                        if (!hasProcessed && hasPurchased) {
                            console.log("所有选中项均已被购买！");
                        }
                    }).fail(function() {
                        console.error("处理部分选中项时出错！");
                    });
                } else {
                    alert("没有找到需要处理的数据！");
                }
            });

    
            // 弹窗中“取消”按钮的逻辑
            $('#cancel-button').click(function() {
                $('#confirm-modal').fadeOut(); // 关闭弹窗
            });
        });
    </script>
    
    
    <script>
        $(document).ready(function() {
            // 页面加载时检查哪些数据已存在，但不打开报告页面
            $('.delete a').each(function() {
                var propertyId = $(this).data('property-id');
                var userId = $(this).data('user-id');
    
                // 发送请求检查是否已存在同意记录
                $.ajax({
                    url: '/check-agreement/',  // 后端检查记录的URL
                    method: 'GET',
                    data: {
                        property_id: propertyId,
                        user_id: userId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'  // 防止跨站请求伪造
                    },
                    success: function(response) {
                        if (response.success && response.agreement_exists) {
                            // 如果同意记录已存在，更新图标为√
                            var icon = $('.delete a[data-property-id="' + propertyId + '"] i');
                            icon.removeClass('fa fa-shopping-cart').addClass('icon-eye');  // 更新图标为√
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("检查失败: " + error);
                    }
                });
            });
    

            // 点击眼睛图标的点击事件
            $('.delete a').click(function(e) {
                e.preventDefault(); // 阻止默认行为

                var propertyId = $(this).data('property-id');
                var userId = $(this).data('user-id');

                if (!propertyId) {
                    alert("未获取到 property_id，请检查！");
                    return;
                }

                // 检查是否已经存在同意记录
                $.ajax({
                    url: '/check-agreement/', // 后端检查记录的URL
                    method: 'GET',
                    data: {
                        property_id: propertyId,
                        user_id: userId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            // 如果 default 或 agreement_exists 为 true，直接打开报告页面
                            if (response.default || response.agreement_exists) {
                                $.ajax({
                                    url: '/agree-to-view/', // 调用 agree-to-view 逻辑
                                    method: 'POST',
                                    data: {
                                        property_id: propertyId,
                                        user_id: userId,
                                        default: response.default, // 确保传递 default 状态
                                        csrfmiddlewaretoken: '{{ csrf_token }}'
                                    },
                                    success: function(response) {
                                        if (response.success) {
                                            var reportUrl = response.report_url || '/report/' + propertyId + '/';
                                            window.open(reportUrl, '_blank');

                                            // 更新图标为√
                                            var icon = $('.delete a[data-property-id="' + propertyId + '"] i');
                                            icon.removeClass('fa fa-shopping-cart').addClass('icon-eye');
                                        }
                                    },
                                    error: function(xhr, status, error) {
                                        console.log("存储失败: " + error);
                                    }
                                });
                            } else {
                                // 如果没有同意记录且 default 为 false，显示同意弹窗
                                $('#confirm-modal').fadeIn();
                                // 保存数据
                                window.selectedProperty = propertyId;
                                window.selectedUser = userId;
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("检查失败: " + error);
                    }
                });
            });
    
            // 点击同意按钮后发送AJAX请求
            $('#agree-button').click(function() {
                var propertyId = window.selectedProperty;
                var userId = window.selectedUser;

                

                // 获取复选框状态，表示是否默认同意
                var isDefaultChecked = $('#default-checkbox').is(':checked'); // 确保复选框的 ID 是 #default-checkbox

                // 发送同意请求
                $.ajax({
                    url: '/agree-to-view/',  // 后端处理URL
                    method: 'POST',
                    data: {
                        property_id: propertyId,
                        user_id: userId,
                        default: isDefaultChecked, // 传递 default 值
                        csrfmiddlewaretoken: '{{ csrf_token }}'  // 防止跨站请求伪造
                    },
                    success: function(response) {
                        if (response.success) {
                            var reportUrl = response.report_url || '/report/' + propertyId + '/';
                            window.open(reportUrl, '_blank');

                            // 更新图标为√
                            var icon = $('.delete a[data-property-id="' + propertyId + '"] i');
                            icon.removeClass('icon-eye').addClass('icon-check');

                            // 关闭弹出框
                            $('#confirm-modal').fadeOut();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("请求失败: " + error);
                    }
                });
            });

    
            // 点击取消按钮后关闭弹出框
            $('#cancel-button').click(function() {
                $('#confirm-modal').fadeOut();  // 关闭弹出框
            });
        });
    </script>
  
  </body>
</html>