<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="pixelstrap">
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Zono - Premium Admin Template</title>
    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
    <!-- ico-font-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
    <!-- Themify icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
    <!-- Flag icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
    <!-- Feather icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatables.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatable-extension.css' %}">
    <!-- Plugins css Ends-->
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
    <!-- App css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
    <!-- Responsive css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
    </head>
    <style>
      /* 调整 .card-header 布局，使标题和搜索框分开显示 */
      .card-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .header-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0; /* 避免额外的填充 */
      }
      
      /* 搜索框的样式调整，确保在右侧显示并不遮挡其他内容 */
      #search-container .dataTables_filter {
          position: relative;
          right: 0;
          top: 0;
          z-index: 10;
          margin-bottom: 0;
          margin: 0;
      }

      /* 搜索框输入框的样式 */
      .dataTables_filter input {
          border: 1px solid #ddd;
          padding: 0px;
          border-radius: 4px;
      }

      /* 页面整体布局调整 */
      .page-body-wrapper {
          padding-left: 0;
      }

      .container-fluid {
          padding-top: 30px;
          padding-right: 20px;
          padding-left: 0;
      }

      .page-wrapper, .page-body {
          min-height: 100vh;
      }

      /* DataTable 表格样式 */
      #keytable {
          width: 100%;
          margin: 0 auto;
      }

      #keytable th, #keytable td {
          white-space: nowrap;
          padding: 8px;
      }

      /* 表头和内容之间的间距 */
      #keytable thead th {
          padding-bottom: 15px;
      }

      /* 分页按钮样式 */
      .dataTables_paginate {
          margin-top: 10px;
          display: flex;
          justify-content: flex-end;
      }
      #confirm-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
    <body>
    {% if messages %}
    <div class="notifications">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %} 
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      {% include 'header.html' %}
      <div class="page-body-wrapper horizontal-menu">
        {% include 'sidenav.html' %}
        <div class="page-body">
          <div class="container-fluid">
            <div class="row"> 
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header pb-0 card-no-border">
                    <div class="header-content">
                        <div id="search-container"></div> <!-- 搜索框的容器 -->
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="display" id="keytable">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>State</th>
                                <th>Property Type</th>
                                <th>Is Online</th>
                                <th>Auction Type</th>
                                <th>Amount In Sale</th>
                                <th>Deposit Deadline</th>
                                <th>Foreclose Score</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr>
                                <td>{{ item.city }}</td>
                                <td>{{ item.state }}</td>
                                <td>{{ item.state }}</td>
                                <td>{{ item.is_online }}</td>
                                <td>{{ item.auction_type }}</td>
                                <td>${{ item.amount_in_sale }}</td>
                                <td>{% if item.deposit_deadline %}{{ item.deposit_deadline }}{% else %}N/A{% endif %}</td>
                                <td><span class="badge badge-light-warning">{{ item.foreclose_score }}</span></td>
                                <td>
                                      <ul class="action">
                                          <li class="edit"><a href="#"><i class="icon-pencil-alt"></i></a></li>
                                          <li class="delete">
                                            <a href="#" data-property-id="{{ item.property_id }}" data-user-id="{{ user.id }}">
                                                <i class="icon-eye"></i>
                                            </a>
                                          </li>
                                      </ul>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 弹出框 -->
        <div id="confirm-modal" style="display: none;">
          <div class="modal-content">
              <p>Are you sure you want to view this report?</p>
              <label>
                  <input type="checkbox" id="default-checkbox"> 
                  Agree to pay by default without showing this notification next time
              </label><br>
              <button id="agree-button">agree</button>
              <button id="cancel-button">cancel</button>
          </div>
        </div>
        {% include 'footer-light.html' %}
          </div>
        </div> 
    <!-- 弹出窗口 -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>   
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <!-- Bootstrap js-->
    <script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <!-- feather icon js-->
    <script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
    <script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
    <!-- scrollbar js-->
    <script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
    <script src="{% static 'js/scrollbar/custom.js' %}"></script>
    <!-- Sidebar jquery-->
    <script src="{% static 'js/config.js' %}"></script>
    <!-- Plugins JS start-->
    <script src="{% static 'js/sidebar-menu.js' %}"></script>
    <script src="{% static 'js/sidebar-pin.js' %}"></script>
    <script src="{% static 'js/slick/slick.min.js' %}"></script>
    <script src="{% static 'js/slick/slick.js' %}"></script>
    <script src="{% static 'js/header-slick.js' %}"></script>
    <script src="{% static 'js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/jszip.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/pdfmake.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/vfs_fonts.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.autoFill.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.select.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.html5.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.print.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/responsive.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.keyTable.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.colReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.fixedHeader.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.rowReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.scroller.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/custom.js' %}"></script>
    <script src="{% static 'js/tooltip-init.js' %}"></script>
    <!-- Plugins JS Ends-->
    <!-- Theme js-->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
    <!-- Plugin used-->
    <script>
      $(document).ready(function() {
          // 检查 DataTable 是否已经初始化，如果是则跳过
          if (!$.fn.DataTable.isDataTable('#keytable')) {
              // 初始化 DataTable
              $('#keytable').DataTable({
                  "autoWidth": false,
                  "responsive": true,
                  "columnDefs": [
                      { "width": "15%", "targets": 0 },
                      { "width": "15%", "targets": 1 },
                      { "width": "20%", "targets": 2 }
                  ]
              });
          }
          
          // 将搜索框移动到 .card-header 中
          $(".dataTables_filter").detach().appendTo(".card-header");
      });
    </script>
    <script>
      $(document).ready(function() {
        // 绑定眼睛图标的点击事件
        $('.delete a').click(function(e) {
            e.preventDefault();  // 阻止默认行为
            console.log('眼睛图标被点击');
    
            var propertyId = $(this).data('property-id'); // 获取property_id
            var userId = $(this).data('user-id'); // 获取user_id
    
            if (!propertyId) {
                console.log("property_id 未获取到！");
                alert("未获取到 property_id，请检查！");
                return;
            }
    
            console.log("获取到的 property_id: " + propertyId);
    
            $('#confirm-modal').fadeIn();  // 显示弹出框
    
            // 保存到全局变量
            window.selectedProperty = propertyId;
            window.selectedUser = userId;
        });
    
        // 点击同意按钮后发送AJAX请求
        $('#agree-button').click(function() {
            var propertyId = window.selectedProperty;
            var userId = window.selectedUser;
            var defaultAgree = $('#default-checkbox').prop('checked');  // 获取是否勾选 "默认同意付费"
    
            if (!propertyId || !userId) {
                console.log("property_id 或 user_id 缺失！");
                alert("缺少必要的参数，请重试！");
                return;
            }
    
            console.log("发送的请求参数 - property_id: " + propertyId + ", user_id: " + userId + ", default: " + defaultAgree);
    
            $.ajax({
                url: '/agree-to-view/',  // 后端处理URL
                method: 'POST',
                data: {
                    property_id: propertyId,
                    user_id: userId,
                    default: defaultAgree,
                    csrfmiddlewaretoken: '{{ csrf_token }}'  // 防止跨站请求伪造
                },
                success: function(response) {
                    if (response.success) {
                        alert("用户同意操作成功！");
                        $('#confirm-modal').fadeOut();  // 关闭弹出框
                        var reportUrl = '/report';  // 根据需求调整报告页面URL
                        window.open(reportUrl, '_blank');
                    } else {
                        console.log('用户已同意过或发生错误');
                        alert("发生错误：用户已同意过或其他问题。");
                    }
                },
                error: function(xhr, status, error) {
                    console.log("请求失败: " + error);
                    alert("请求失败，请稍后重试。");
                }
            });
        });
    
        // 点击取消按钮后关闭弹出框
        $('#cancel-button').click(function() {
            $('#confirm-modal').fadeOut();  // 关闭弹出框
        });
    });
  </script>
  
  </script>  
  </body>
</html>