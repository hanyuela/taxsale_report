<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="pixelstrap">
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Zono - Premium Admin Template</title>
    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
    <!-- ico-font-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
    <!-- Themify icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
    <!-- Flag icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
    <!-- Feather icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
    <!-- Plugins css Ends-->
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
    <!-- App css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
    <!-- Responsive css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
  </head>
  <style>
    /* 外部容器样式，统一设置最大宽度和居中显示 */
    .profile-container {
      max-width: 600px; /* 设置最大宽度 */
      margin: 0 auto; /* 居中显示 */
      padding: 17px; /* 左右内边距 */
      box-sizing: border-box; /* 包括内边距在内的宽度计算 */
    }

    /* 统一输入框样式 */
    .profile-container .form-control {
      width: 100%; /* 输入框宽度100%，但受容器限制 */
      padding: 10px 12px; /* 输入框内边距 */
      box-sizing: border-box; /* 保证宽度包含内边距 */
    }

    /* 统一标签样式 */
    .profile-container .form-label {
      display: block; /* 标签单独一行显示 */
      margin-bottom: 8px; /* 标签与输入框的间距 */
      color: #333; /* 标签字体颜色 */
      font-weight: bold; /* 标签字体加粗 */
    }

    /* 按钮样式 */
    .profile-container .btn {
      margin-top: 5px; /* 按钮与输入框的间距 */
      padding: 10px;
      width: 100%;
    }
    /* 设置外部容器整体样式 */
    .card {
      padding: 20px; /* 添加内边距 */
      max-width: 800px; /* 设置最大宽度，确保不会过于宽 */
      margin: 0 auto; /* 居中显示 */
      box-sizing: border-box; /* 包括内边距在内计算宽度 */
    }

    /* 输入框和复选框的通用样式 */
    .card .form-control,
    .card input[type="radio"],
    .card input[type="checkbox"] {
      margin-left: 10px; /* 增加左边距 */
    }

    /* 标签与输入框对齐 */
    .card label {
      margin-left: 10px; /* 标签左边距 */
      font-weight: bold; /* 标签加粗 */
      color: #333; /* 标签字体颜色 */
    }

    /* 调整单选框和复选框 */
    .card input[type="radio"],
    .card input[type="checkbox"] {
      margin-right: 5px; /* 控件与标签之间的间距 */
    }

    /* 提交按钮样式 */
    .card-footer .btn {
      margin-top: 10px;
      padding: 10px 20px;
    }
  </style>
  <body> 
    {% if messages %}
      {% for message in messages %}
        <div class="alert 
          {% if message.tags == 'success' %}alert-success
          {% elif message.tags == 'error' %}alert-danger
          {% elif message.tags == 'warning' %}alert-warning
          {% else %}alert-info{% endif %} 
          alert-dismissible fade show" role="alert" style="z-index: 9999; position: relative;">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
    <!-- loader starts-->
    <div class="loader-wrapper">
      <div class="theme-loader">    
        <div class="loader-p"></div>
      </div>
    </div>
    <!-- loader ends-->
    <!-- tap on top starts-->
    <div class="tap-top"><i data-feather="chevrons-up"></i></div>
    <!-- tap on tap ends-->
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      <!-- Page Header Start-->
      {% include 'header.html' %}
      <!-- Page Header Ends                              -->
      <!-- Page Body Start-->
      <div class="page-body-wrapper">
        <!-- Page Sidebar Start-->
        {% include 'sidenav.html' %}
        <!-- Page Sidebar Ends-->
        <div class="page-body">
          <div class="container-fluid">
            <div class="page-title">
              <div class="row">
                <div class="col-xl-3 col-sm-5 box-col-4">                 
                </div>
              </div>
            </div>
          </div>
          <!-- Container-fluid starts-->
          <div class="container-fluid">
            <div class="edit-profile">
              <div class="row">
                <div class="col-xl-4">
                  <div class="card">
                    <div class="card-header pb-0">
                      <h4 class="card-title mb-0">My Profile</h4>
                      <div class="card-options"><a class="card-options-collapse" href="#" data-bs-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a><a class="card-options-remove" href="#" data-bs-toggle="card-remove"><i class="fe fe-x"></i></a></div>
                    </div>
                    <div class="card-body">

                      <!-- 修改头像表单 -->
                      <form id="avatar-upload-form" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row mb-2">
                          <div class="profile-title">
                            <div class="d-flex">
                              <!-- 显示用户头像 -->
                              <label for="avatar-upload">
                                <img class="img-70 rounded-circle" alt="User Avatar"
                                     src="{% if user.profile.avatar_path %}{{ user.profile.avatar_path }}{% else %}{% static 'images/user/7.jpg' %}{% endif %}"
                                     id="avatar-img" style="cursor: pointer;">
                              </label>
                              <input type="file" id="avatar-upload" name="avatar" style="display: none;" onchange="uploadAvatar();">
                              <div class="flex-grow-1">
                                {% if user.is_authenticated %}
                                  {{ user.username }}
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </form>
                      
                      

                        {% csrf_token %}
                        <!-- 修改邮箱表单 -->
                        <div class="profile-container">
                          <div class="mb-3">
                            <label class="form-label">Current Email</label>
                            <input class="form-control" type="email" value="{{ user.username }}" disabled>
                          </div>
                          
                          <div class="mb-3 row align-items-center">
                            <!-- 输入框 -->
                            <div class="col-md-9">
                              <label class="form-label">New Email Address</label>
                              <input class="form-control" type="email" name="new_email" placeholder="Enter new email" required>
                            </div>
                            <!-- 按钮 -->
                            <div class="col-md-3 mt-4">
                              <button class="btn btn-primary w-100" type="submit" name="update-email">Verify</button>
                            </div>
                          </div>
                        </div>
                        </form>
                      <hr> <!-- 分割线，区分两个表单 -->                
                      <!-- 修改密码表单 -->
                      <form method="POST" action="{% url 'change_password' %}">
                        {% csrf_token %}
                        <div class="profile-container">
                          <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input class="form-control" type="password" name="password" placeholder="Enter new password" required>
                          </div>
                    
                          <div class="mb-3">
                            <label class="form-label">Repeat New Password</label>
                            <input class="form-control" type="password" name="repeat_password" placeholder="Repeat new password" required>
                          </div>
                    
                          <!-- 提交按钮 -->
                          <div class="form-footer">
                            <button class="btn btn-primary" type="submit">Save</button>
                          </div>
                        </div>
                      </form>
                    </div>                   
                  </div>
                </div>
                <!-- profile start-->
                <div class="col-xl-8">
                  <form class="card" method="POST" action="{% url 'profile_update' %}">
                    {% csrf_token %}
                    <div class="card-header pb-0">
                      <h4 class="card-title mb-0">Edit Profile</h4>
                      <div class="card-options">
                        <a class="card-options-collapse" href="#" data-bs-toggle="card-collapse"><i class="fe fe-chevron-up"></i></a>
                        <a class="card-options-remove" href="#" data-bs-toggle="card-remove"><i class="fe fe-x"></i></a>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <!-- First Name -->
                        <div class="form-group mb-3 col-md-6">
                          <label for="first_name">First Name</label>
                          <input class="form-control" id="first_name" type="text" name="first_name" value="{{ user_profile.first_name }}">
                        </div>

                        <!-- Last Name -->
                        <div class="form-group mb-3 col-md-6">
                          <label for="last_name">Last Name</label>
                          <input class="form-control" id="last_name" type="text" name="last_name" value="{{ user_profile.last_name }}">
                        </div>

                        <!-- Phone Number -->
                        <div class="form-group mb-3 col-md-6">
                          <label for="phone_number">Phone Number</label>
                          <input class="form-control" id="phone_number" type="text" name="phone_number" value="{{ user_profile.phone_number }}">
                        </div>

                        <!-- Investment Amount -->
                        <div class="form-group mb-3 col-md-6">
                          <label for="investment_amount">How much are you planning to invest in tax sales?</label>
                          <input class="form-control" id="investment_amount" type="number" name="investment_amount" value="{{ user_profile.investment_amount }}" max="1000000000" oninput="adjustMaxValue(this)">
                        </div>
                    
                        <!-- Investment Purpose -->
                        <div class="form-group mb-3 col-md-12">
                          <label for="investment_purpose">What is your main purpose for investing in tax sales?</label><br>
                          <input type="radio" id="earn_interest" name="goal" value="Earn Interest" {% if user_profile.goal == 'Earn Interest' %}checked{% endif %}>
                          <label for="earn_interest">Earn Interest</label><br>
                          <input type="radio" id="foreclose_property" name="goal" value="Foreclose on properties" {% if user_profile.goal == 'Foreclose on properties' %}checked{% endif %}>
                          <label for="foreclose_property">Foreclose on properties</label><br>
                        </div>
                        <div class="form-group mb-3 col-md-12">
                          <label for="default">
                            <input type="checkbox" id="default" name="default" {% if user_profile.default %}checked{% endif %}>
                            Agree to pay by default without showing this notification next time
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="card-footer text-end">
                      <button class="btn btn-primary" type="submit">Update Profile</button>
                    </div>
                  </form>
                </div>
                <!-- profile End -->
              </div>
            </div>
          </div>
          <!-- Container-fluid Ends-->
        </div>
        <!-- footer start-->
        {% include 'footer-light.html' %}
      </div>
    </div>
    <script>
      function uploadAvatar() {
        var formData = new FormData();
        var avatarFile = document.getElementById('avatar-upload').files[0];
        formData.append('avatar', avatarFile);
    
        // 发送 AJAX 请求
        fetch("{% url 'update_avatar' %}", {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value  // 添加 CSRF Token
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 更新头像
            document.getElementById('avatar-img').src = data.avatar_url;
            alert('头像上传成功！');
          } else {
            alert('上传失败，请稍后再试。');
          }
        })
        .catch(error => {
          alert('上传失败，请稍后再试。');
        });
      }
    </script>
    
    <script>
      function submitPasswordForm() {
        const newPassword = document.getElementById("new_password").value;
        const repeatPassword = document.getElementById("repeat_password").value;
        const errorDiv = document.getElementById("password-error");

        if (newPassword !== repeatPassword) {
          errorDiv.style.display = "block";
        } else {
          errorDiv.style.display = "none";
          document.getElementById("change-password-form").submit();
        }
      }

    </script>
    <!-- latest jquery-->
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <!-- Bootstrap js-->
    <script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <!-- feather icon js-->
    <script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
    <script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
    <!-- scrollbar js-->
    <script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
    <script src="{% static 'js/scrollbar/custom.js' %}"></script>
    <!-- Sidebar jquery-->
    <script src="{% static 'js/config.js' %}"></script>
    <!-- Plugins JS start-->
    <script src="{% static 'js/sidebar-menu.js' %}"></script>
    <script src="{% static 'js/sidebar-pin.js' %}"></script>
    <script src="{% static 'js/slick/slick.min.js' %}"></script>
    <script src="{% static 'js/slick/slick.js' %}"></script>
    <script src="{% static 'js/header-slick.js' %}"></script>
    <!-- Plugins JS Ends-->
    <!-- Theme js-->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
    <!-- Plugin used-->
  </body>
</html>