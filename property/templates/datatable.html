<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zono admin is super flexible, powerful, clean &amp; modern responsive bootstrap 5 admin template with unlimited possibilities.">
    <meta name="keywords" content="admin template, Zono admin template, dashboard template, flat admin template, responsive admin template, web app">
    <meta name="author" content="pixelstrap">
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <title>Zono - Premium Admin Template</title>
    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i,900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome.css' %}">
    <!-- ico-font-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/icofont.css' %}">
    <!-- Themify icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/themify.css' %}">
    <!-- Flag icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/flag-icon.css' %}">
    <!-- Feather icon-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/feather-icon.css' %}">
    <!-- Plugins css start-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/animate.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatables.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/datatable-extension.css' %}">
    <!-- Plugins css Ends-->
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/vendors/bootstrap.css' %}">
    <!-- App css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'css/color-1.css' %}" media="screen">
    <!-- Responsive css-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">
    </head>
    <style>
      /* 调整 .card-header 布局，使标题和搜索框分开显示 */
      .card-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .header-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0; /* 避免额外的填充 */
      }
      
      /* 搜索框的样式调整，确保在右侧显示并不遮挡其他内容 */
      #search-container .dataTables_filter {
          position: relative;
          right: 0;
          top: 0;
          z-index: 10;
          margin-bottom: 0;
          margin: 0;
      }

      /* 搜索框输入框的样式 */
      .dataTables_filter input {
          border: 1px solid #ddd;
          padding: 0px;
          border-radius: 4px;
      }

      /* 页面整体布局调整 */
      .page-body-wrapper {
          padding-left: 0;
      }

      .container-fluid {
          padding-top: 30px;
          padding-right: 20px;
          padding-left: 0;
      }

      .page-wrapper, .page-body {
          min-height: 100vh;
      }

      /* DataTable 表格样式 */
      #keytable {
          width: 100%;
          margin: 0 auto;
      }

      #keytable th, #keytable td {
          white-space: nowrap;
          padding: 8px;
      }

      /* 表头和内容之间的间距 */
      #keytable thead th {
          padding-bottom: 15px;
      }

      /* 分页按钮样式 */
      .dataTables_paginate {
          margin-top: 10px;
          display: flex;
          justify-content: flex-end;
      }
      #confirm-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
    <body>
    {% if messages %}
    <div class="notifications">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %} 
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
      {% include 'header.html' %}
      <div class="page-body-wrapper horizontal-menu">
        {% include 'sidenav.html' %}
        <div class="page-body">
          <div class="container-fluid">
            <div class="row"> 
              <div class="col-sm-12">
                <div class="card">
                  <div class="card-header pb-0 card-no-border">
                    <div class="header-content">
                        <div id="search-container"></div> <!-- 搜索框的容器 -->
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="display" id="keytable">
                        <thead>
                            <tr>
                                <th>street address</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Property Type</th>
                                <th>Is Online</th>
                                <th>Auction Type</th>
                                <th>Amount In Sale</th>
                                <th>Deposit Deadline</th>
                                <th>
                                    <div>Foreclose</div>
                                    <div>Score</div>
                                </th>                                
                                <th>Action</th>
                                <th><input type="checkbox" id="select_all" /></th> <!-- 表头全选 -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr>
                                <td>{{ item.street_address}}
                                <td>{{ item.city }}</td>
                                <td>{{ item.state }}</td>
                                <td>{{ item.property_class }}</td>
                                <td>{{ item.is_online }}</td>
                                <td>{{ item.auction_type }}</td>
                                <td>${{ item.amount_in_sale }}</td>
                                <td>{% if item.deposit_deadline %}{{ item.deposit_deadline }}{% else %}N/A{% endif %}</td>
                                <td><span class="badge badge-light-warning">{{ item.foreclose_score }}</span></td>
                                <td>
                                      <ul class="action">
                                          
                                          <li class="delete">
                                            <a href="#" data-property-id="{{ item.property_id }}" data-user-id="{{ user.id }}">
                                                <i class="fa fa-shopping-cart"></i>
                                            </a>
                                          </li>
                                      </ul>
                                </td>
                                <td><input type="checkbox" class="row-select" /></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 弹出框 -->
        <div id="confirm-modal" style="display: none;">
          <div class="modal-content">
              <p>Are you sure you want to view this report?</p>
              <p>A fee of $5 will be charged per report.</p>
              <label>
                  <input type="checkbox" id="default-checkbox"> 
                  Agree to pay by default without showing this notification next time
              </label><br>
              <button id="agree-button">agree</button>
              <button id="cancel-button">cancel</button>
          </div>
        </div>
        {% include 'footer-light.html' %}
          </div>
        </div> 
    <!-- 弹出窗口 -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>   
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <!-- Bootstrap js-->
    <script src="{% static 'js/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <!-- feather icon js-->
    <script src="{% static 'js/icons/feather-icon/feather.min.js' %}"></script>
    <script src="{% static 'js/icons/feather-icon/feather-icon.js' %}"></script>
    <!-- scrollbar js-->
    <script src="{% static 'js/scrollbar/simplebar.js' %}"></script>
    <script src="{% static 'js/scrollbar/custom.js' %}"></script>
    <!-- Sidebar jquery-->
    <script src="{% static 'js/config.js' %}"></script>
    <!-- Plugins JS start-->
    <script src="{% static 'js/sidebar-menu.js' %}"></script>
    <script src="{% static 'js/sidebar-pin.js' %}"></script>
    <script src="{% static 'js/slick/slick.min.js' %}"></script>
    <script src="{% static 'js/slick/slick.js' %}"></script>
    <script src="{% static 'js/header-slick.js' %}"></script>
    <script src="{% static 'js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/jszip.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/pdfmake.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/vfs_fonts.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.autoFill.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.select.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.html5.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/buttons.print.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/responsive.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.keyTable.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.colReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.fixedHeader.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.rowReorder.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/dataTables.scroller.min.js' %}"></script>
    <script src="{% static 'js/datatable/datatable-extension/custom.js' %}"></script>
    <script src="{% static 'js/tooltip-init.js' %}"></script>
    <!-- Plugins JS Ends-->
    <!-- Theme js-->
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/theme-customizer/customizer.js' %}"></script>
    <!-- Plugin used-->
    <script>
        $(document).ready(function() {
            
            // 初始化 DataTable
            if (!$.fn.DataTable.isDataTable('#keytable')) {
                $('#keytable').DataTable({
                    "autoWidth": false,
                    "responsive": true,
                    "columnDefs": [
                        { "width": "15%", "targets": 0 },
                        { "width": "15%", "targets": 1 },
                        { "width": "20%", "targets": 2 }
                    ]
                });
            }
    
            // 将搜索框移动到 .card-header 中
            $(".dataTables_filter").detach().appendTo(".card-header");
    
            // 添加“统一购买”按钮到分页控件的最后
            $(".dataTables_paginate").append('<button class="bulk-purchase-btn btn btn-primary" style="margin-left: 10px;"><i class="fa fa-shopping-cart"></i></button>');
            
            // 防止全选复选框误触跳转
            $('#select_all').click(function(event) {
                event.stopPropagation(); // 阻止事件冒泡，防止误触导致跳转
                var isChecked = $(this).prop('checked'); // 获取全选框的状态

                // 获取 DataTable 实例
                var table = $('#keytable').DataTable();

                // 只操作当前页未禁用的复选框
                table.rows({ page: 'current' }).nodes().each(function(row) {
                    var checkbox = $(row).find('.row-select'); // 获取复选框
                    if (!checkbox.prop('disabled')) { // 跳过已禁用的复选框
                        checkbox.prop('checked', isChecked); // 设置当前页未禁用复选框的状态
                    }
                });
            });


    
            // 监听每一行的点击事件，排除购物车按钮点击
            $('#keytable tbody').on('click', 'tr', function(e) {
                // 如果点击的是购物车按钮，直接返回，不做处理
                if ($(e.target).closest('.delete a').length > 0) {
                    return;
                }
                var checkbox = $(this).find('.row-select'); // 获取当前行的复选框
                checkbox.prop('checked', !checkbox.prop('checked')); // 反转选中状态
            });
    
            // 监听每个复选框的点击事件，防止影响到行点击的事件
            $('#keytable tbody').on('click', '.row-select', function(e) {
                e.stopPropagation(); // 阻止点击事件冒泡到行上
            });
    
            // 购物车按钮的点击事件
            $('#keytable tbody').on('click', '.delete a', function(e) {
                e.preventDefault(); // 阻止默认行为
                console.log("购物车按钮被点击！");
            });

            // 添加购物车按钮函数
            function addBulkPurchaseButton() {
                if (!$(".bulk-purchase-btn").length) { // 检查按钮是否已经存在
                    $(".dataTables_paginate").append('<button class="bulk-purchase-btn btn btn-primary" style="margin-left: 10px;"><i class="fa fa-shopping-cart"></i></button>');
                }
            }

            // 初始加载时添加按钮
            addBulkPurchaseButton();

            // 监听 DataTables 的 draw 事件，确保分页或操作时按钮不被删除
            $('#keytable').on('draw.dt', function() {
                addBulkPurchaseButton();
            });
            
            
            
            // 绑定“统一购买”按钮的点击事件
            $(document).on('click', '.bulk-purchase-btn', function() {
                var selectedRows = $('.row-select:checked');

                // 检查是否有选中的行
                if (selectedRows.length > 0) {
                    var bulkData = [];
                    var checkRequests = []; // 用于存放检查请求

                    // 先检查用户余额
                    $.ajax({
                        url: '/check-balance/',
                        method: 'GET',
                        success: function(balanceResponse) {
                            if (balanceResponse.success) {
                                var remainingBalance = balanceResponse.balance;

                                // 检查余额是否足够
                                if (remainingBalance <= 0) {
                                    // 余额不足，直接跳转到支付页面
                                    window.location.href = '/payments?error=insufficient_funds';
                                    return;
                                }

                                // 余额足够，继续处理选中的行
                                selectedRows.each(function() {
                                    var row = $(this).closest('tr'); // 获取当前行
                                    var propertyId = row.find('.delete a').data('property-id'); // 从 `a` 标签中获取 data-property-id
                                    var userId = row.find('.delete a').data('user-id'); // 从 `a` 标签中获取 data-user-id

                                    if (propertyId && userId) {
                                        bulkData.push({ propertyId, userId });

                                        // 检查 `agreement_exists`
                                        var checkRequest = $.ajax({
                                            url: '/check-agreement/',
                                            method: 'GET',
                                            data: {
                                                property_id: propertyId,
                                                user_id: userId,
                                                csrfmiddlewaretoken: '{{ csrf_token }}'
                                            },
                                            success: function(response) {
                                                if (response.success) {
                                                    if (response.agreement_exists) {
                                                        // 如果 agreement_exists 为 true，直接处理
                                                        $.ajax({
                                                            url: '/agree-to-view/',
                                                            method: 'POST',
                                                            data: {
                                                                property_id: propertyId,
                                                                user_id: userId,
                                                                default: true, // 直接默认同意
                                                                csrfmiddlewaretoken: '{{ csrf_token }}'
                                                            },
                                                            success: function(res) {
                                                                if (res.success) {
                                                                    console.log(`成功处理 property_id: ${propertyId}`);
                                                                } else if (res.error === 'insufficient_funds') {
                                                                    // 如果余额不足，直接跳转到支付页面
                                                                    window.location.href = '/payments?error=insufficient_funds';
                                                                }
                                                            },
                                                            error: function(xhr, status, error) {
                                                                console.error(`处理失败 property_id: ${propertyId}, 错误: ${error}`);
                                                            }
                                                        });
                                                    }
                                                }
                                            },
                                            error: function(xhr, status, error) {
                                                console.error(`检查失败 property_id: ${propertyId}, 错误: ${error}`);
                                            }
                                        });
                                        checkRequests.push(checkRequest);
                                    } else {
                                        console.log("缺少 property_id 或 user_id，跳过该行");
                                    }
                                });

                                // 等待所有检查请求完成
                                $.when.apply($, checkRequests).done(function() {
                                    // 检查完毕后，过滤出需要弹出同意窗口的数据
                                    var pendingApproval = bulkData.filter(function(item) {
                                        // 根据检查结果决定是否需要同意窗口
                                        var checkbox = $(`.delete a[data-property-id="${item.propertyId}"]`);
                                        return !checkbox.data('agreement-exists'); // 只有 `agreement_exists == false` 才需要弹窗
                                    });

                                    if (pendingApproval.length > 0) {
                                        // 弹出同意窗口，保存待处理数据
                                        window.bulkSelectedData = pendingApproval;
                                        $('#confirm-modal').fadeIn();
                                    } else {
                                        alert("已成功处理所有选中项！");
                                    }
                                });
                            } else {
                                console.error("检查余额失败: " + balanceResponse.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("检查余额请求失败: " + error);
                        }
                    });
                } else {
                    alert("Please select at least one item for purchase first!");
                }
            });

            $(document).ready(function() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('error') === 'insufficient_funds') {
                    alert('Insufficient funds, please add money.');
                }
            });
            
            // 弹窗中“同意”按钮的逻辑
            $('#agree-button').off('click').on('click', function() {
                if (window.bulkSelectedData && window.bulkSelectedData.length > 0) {
                    // 计算总费用：选中数量 × 100 美金
                    const totalCost = window.bulkSelectedData.length * 5;
                    
                    // 先检查用户余额是否足够支付总费用
                    $.ajax({
                        url: '/check-balance/',
                        method: 'GET',
                        success: function(response) {
                            if (response.success) {
                                const remainingBalance = response.balance;
                                
                                if (remainingBalance >= totalCost) {
                                    // 余额足够，逐个处理购买请求
                                    let allSuccess = true;
                                    let hasInsufficientFunds = false;
                                    
                                    // 遍历所有选中的项
                                    window.bulkSelectedData.forEach(function(item) {
                                        $.ajax({
                                            url: '/agree-to-view/',
                                            method: 'POST',
                                            async: false,  // 同步请求，确保顺序执行
                                            data: {
                                                property_id: item.propertyId,
                                                user_id: item.userId,
                                                default: $('#default-checkbox').is(':checked'),
                                                csrfmiddlewaretoken: '{{ csrf_token }}'
                                            },
                                            success: function(response) {
                                                if (response.success) {
                                                    // 更新图标为 √
                                                    const icon = $(`.delete a[data-property-id="${item.propertyId}"] i`);
                                                    icon.removeClass('fa-shopping-cart').addClass('icon-check');
                                                } else {
                                                    allSuccess = false;
                                                    if (response.error === 'Insufficient Funds') {
                                                        hasInsufficientFunds = true;
                                                    }
                                                }
                                            },
                                            
                                            error: function(xhr) {
                                                allSuccess = false;
                                                console.error(`请求失败 property_id: ${item.propertyId}`, xhr.responseText);
                                            }
                                        });
                                    });

                                    // 统一处理结果
                                    if (allSuccess) {
                                        alert('所有报告购买成功！');
                                        window.bulkSelectedData = [];
                                        $('#confirm-modal').fadeOut();
                                    } else if (hasInsufficientFunds) {
                                        alert('Insufficient Funds');
                                        window.location.href = '/payments/';
                                    } else {
                                        alert('部分报告购买失败，请重试！');
                                    }
                                } else {
                                    // 余额不足，直接跳转
                                    alert('Insufficient Funds');
                                    window.location.href = '/payments/';
                                }
                            }
                        },
                        error: function(xhr) {
                            console.error('检查余额失败:', xhr.responseText);
                        }
                    });
                }
            });

    
            // 弹窗中“取消”按钮的逻辑
            $('#cancel-button').click(function() {
                $('#confirm-modal').fadeOut(); // 关闭弹窗
            });
        });
    </script>
    
    
    <script>
        $(document).ready(function() {
            // 页面加载时检查哪些数据已存在，但不打开报告页面
            var table = $('#keytable').DataTable(); // 初始化 DataTable 实例
            
            // 遍历所有行，检查是否已存在同意记录
            table.rows().every(function () {
                var row = $(this.node()); // 获取行的 DOM 节点
                var propertyId = row.find('.delete a').data('property-id');
                var userId = row.find('.delete a').data('user-id');
        
                // 确保 propertyId 和 userId 存在
                if (propertyId && userId) {
                    // 发送 AJAX 请求检查是否已存在同意记录
                    $.ajax({
                        url: '/check-agreement/', // 后端检查记录的 URL
                        method: 'GET',
                        data: {
                            property_id: propertyId,
                            user_id: userId,
                            csrfmiddlewaretoken: '{{ csrf_token }}' // 防止跨站请求伪造
                        },
                        success: function (response) {
                            if (response.success && response.agreement_exists) {
                                // 如果同意记录已存在，更新图标为 √
                                var icon = row.find('.delete a i'); // 找到当前行的图标
                                icon.removeClass('fa fa-shopping-cart').addClass('icon-eye'); // 更新图标为 √
                                var auctionCell = row.find('.row-select').closest('td'); // 找到复选框所在的单元格
                                row.find('.row-select').prop('disabled', true); // 禁用复选框
                                auctionCell.css({
                                    'background-color': '#f0f0f0', // 设置单元格灰色背景
                                    'opacity': '0.5' // 设置透明度
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.log("检查失败: " + error);
                        }
                    });
                }
            });
    

            // 点击眼睛图标的点击事件
            $('#keytable tbody').on('click', '.delete a', function(e) {
                e.preventDefault(); // 阻止默认行为

                var propertyId = $(this).data('property-id');
                var userId = $(this).data('user-id');

                if (!propertyId) {
                    alert("未获取到 property_id，请检查！");
                    return;
                }

                // 先检查用户余额
                $.ajax({
                    url: '/check-balance/',
                    method: 'GET',
                    success: function(balanceResponse) {
                        if (balanceResponse.success) {
                            var remainingBalance = balanceResponse.balance;

                            // 检查余额是否足够
                            if (remainingBalance <= 0) {
                                // 余额不足，直接跳转到支付页面
                                window.location.href = '/payments?error=insufficient_funds';
                                return;
                            }

                            // 余额足够，继续检查是否已经存在同意记录
                            $.ajax({
                                url: '/check-agreement/', // 后端检查记录的URL
                                method: 'GET',
                                data: {
                                    property_id: propertyId,
                                    user_id: userId,
                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    if (response.success) {
                                        // 如果 default 或 agreement_exists 为 true，直接打开报告页面
                                        if (response.default || response.agreement_exists) {
                                            $.ajax({
                                                url: '/agree-to-view/', // 调用 agree-to-view 逻辑
                                                method: 'POST',
                                                data: {
                                                    property_id: propertyId,
                                                    user_id: userId,
                                                    default: response.default, // 确保传递 default 状态
                                                    csrfmiddlewaretoken: '{{ csrf_token }}'
                                                },
                                                success: function(response) {
                                                    if (response.success) {
                                                        var reportUrl = response.report_url || '/report/' + propertyId + '/';
                                                        window.open(reportUrl, '_blank');

                                                        // 更新图标为√
                                                        var icon = $('.delete a[data-property-id="' + propertyId + '"] i');
                                                        icon.removeClass('fa fa-shopping-cart').addClass('icon-eye');
                                                    } else if (response.error === 'Insufficient Funds') {
                                                        // 如果余额不足，直接跳转到支付页面
                                                        window.location.href = '/payments?error=insufficient_funds';
                                                    }
                                                },
                                                error: function(xhr, status, error) {
                                                    console.log("存储失败: " + error);
                                                }
                                            });
                                        } else {
                                            // 如果没有同意记录且 default 为 false，显示同意弹窗
                                            $('#confirm-modal').fadeIn();
                                            // 保存数据
                                            window.selectedProperty = propertyId;
                                            window.selectedUser = userId;
                                        }
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.log("检查失败: " + error);
                                }
                            });
                        } else {
                            console.error("检查余额失败: " + balanceResponse.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("检查余额请求失败: " + error);
                    }
                });
            });
    
            // 点击同意按钮后发送AJAX请求
            // 点击同意按钮后发送AJAX请求
            $('#agree-button').click(function() {
                var propertyId = window.selectedProperty;
                var userId = window.selectedUser;

                // 获取复选框状态，表示是否默认同意
                var isDefaultChecked = $('#default-checkbox').is(':checked'); // 确保复选框的 ID 是 #default-checkbox

                // 发送同意请求
                $.ajax({
                    url: '/agree-to-view/',  // 后端处理URL
                    method: 'POST',
                    data: {
                        property_id: propertyId,
                        user_id: userId,
                        default: isDefaultChecked, // 传递 default 值
                        csrfmiddlewaretoken: '{{ csrf_token }}'  // 防止跨站请求伪造
                    },
                    success: function(response) {
                        if (response.success) {
                            var reportUrl = response.report_url || '/report/' + propertyId + '/';
                            window.open(reportUrl, '_blank');

                            // 更新图标为√
                            var icon = $('.delete a[data-property-id="' + propertyId + '"] i');
                            icon.removeClass('icon-eye').addClass('icon-check');

                            // 关闭弹出框
                            $('#confirm-modal').fadeOut();
                        } else {
                            // 如果返回的 success 为 false，表示发生了错误或余额不足
                            if (response.error === 'Insufficient Funds') {
                                // 弹出余额不足的提示
                                alert(response.error);  // 显示错误信息
                                window.location.href = response.redirect_url;  // 跳转到付款页面
                            } else {
                                alert('Error: ' + (response.error || 'Unknown error occurred.'));
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("请求失败: " + error);
                    }
                });
            });


    
            // 点击取消按钮后关闭弹出框
            $('#cancel-button').click(function() {
                $('#confirm-modal').fadeOut();  // 关闭弹出框
            });
        });
    </script>
  
  </body>
</html>